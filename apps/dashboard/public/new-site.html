<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Site • Fidbak</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; }
      header, footer { padding: 12px 16px; border-bottom: 1px solid #e5e7eb; }
      main { max-width: 760px; margin: 24px auto; padding: 0 16px; }
      form { display: grid; gap: 12px; margin-top: 8px; }
      input, button { font-size: 16px; padding: 10px 12px; border-radius: 10px; border: 1px solid #e5e7eb; }
      button { background: #111; color: #fff; cursor: pointer; }
      .row { display: grid; gap: 6px; }
      .hint { color: #6b7280; font-size: 14px; }
      .ok { color: #065f46; }
      .err { color: #9f1239; }
      pre { background: #0b1021; color: #e6e6e6; padding: 12px; border-radius: 8px; overflow: auto; }
      a { color: #111; }
    </style>
    <script src="/env.js"></script>
  </head>
  <body>
    <header>
      <strong>Fidbak</strong>
    </header>
    <main>
      <h1>Create Site</h1>
      <p class="hint">Create a Site ID and allowlist your primary docs origin. You’ll get a link to the dashboard and ready‑to‑paste widget snippets.</p>

      <form id="f">
        <div class="row">
          <label for="id">Site ID (lowercase, hyphens)</label>
          <input id="id" name="id" placeholder="acme-docs" required pattern="[a-z0-9-]{3,}" />
        </div>
        <div class="row">
          <label for="name">Display name</label>
          <input id="name" name="name" placeholder="Acme Docs" />
        </div>
        <div class="row">
          <label for="email">Owner email (optional)</label>
          <input id="email" name="email" placeholder="owner@acme.com" type="email" />
        </div>
        <div class="row">
          <label for="origin">Primary origin (https://...)</label>
          <input id="origin" name="origin" placeholder="https://docs.acme.com" required />
        </div>
        <div class="row">
          <label for="more">Additional origins (comma‑separated, optional)</label>
          <input id="more" name="more" placeholder="https://help.acme.com, https://www.acme.com" />
          <span class="hint">We’ll add any valid https:// or http:// origins you list here.</span>
        </div>
        <div class="row">
          <label>Presets</label>
          <label><input type="checkbox" id="incDash" checked /> Include this dashboard origin</label>
          <label><input type="checkbox" id="incLocal5173" /> Include http://localhost:5173</label>
          <label><input type="checkbox" id="incLocal5174" /> Include http://localhost:5174</label>
          <label><input type="checkbox" id="incLocal5181" /> Include http://localhost:5181</label>
        </div>
        <div class="row">
          <button type="submit">Create Site</button>
        </div>
      </form>

      <div id="out"></div>
    </main>
    <footer style="border-top: 1px solid #e5e7eb; padding: 12px 16px; color: #6b7280;">
      © Fidbak
    </footer>

    <script>
      const API = (window.__FIDBAK_API_BASE || '').replace(/\/$/, '');
      const f = document.getElementById('f');
      const out = document.getElementById('out');
      const incDash = document.getElementById('incDash');
      const incLocal5173 = document.getElementById('incLocal5173');
      const incLocal5174 = document.getElementById('incLocal5174');
      const incLocal5181 = document.getElementById('incLocal5181');

      f.addEventListener('submit', async (e) => {
        e.preventDefault();
        out.textContent = '';
        const id = f.id.value.trim();
        const name = f.name.value.trim();
        const ownerEmail = f.email.value.trim();
        const origin = f.origin.value.trim();
        const more = f.more.value.trim();

        const origins = [];
        // Parse additional origins
        if (more) {
          more.split(',').map(s => s.trim()).filter(Boolean).forEach((o) => origins.push(o));
        }
        // Presets
        if (incDash.checked) origins.push(location.origin);
        if (incLocal5173.checked) origins.push('http://localhost:5173');
        if (incLocal5174.checked) origins.push('http://localhost:5174');
        if (incLocal5181.checked) origins.push('http://localhost:5181');

        try {
          const r = await fetch(API + '/v1/sites', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ id, name, ownerEmail, origin, origins })
          });
          const j = await r.json().catch(() => ({}));
          if (!r.ok || !j.ok) throw new Error(j.error || 'Create failed');
          const dash = j.dashboard || (location.origin + '/?siteId=' + encodeURIComponent(id));

          out.innerHTML = `
            <p class="ok">Site created.</p>
            <p><a href="${dash}">Open Dashboard for ${id}</a></p>
            <p class="hint">Paste one of these snippets into your site:</p>
            <pre><code>&lt;script type="module">
  import fidbak from '@fidbak/widget';
  fidbak('init', {
    siteId: '${id}',
    apiBaseUrl: '${API}',
    theme: 'auto',
    webhookUrl: ['https://hooks.slack.com/services/XXX/YYY/ZZZ'],
    debounceMs: 30000
  });
&lt;/script></code></pre>

            <pre><code>&lt;script src="https://unpkg.com/@fidbak/widget@0.1.2/dist/fidbak.fab.min.global.js"&gt;&lt;/script&gt;
&lt;script&gt;
  window.fidbak('init', {
    siteId: '${id}',
    apiBaseUrl: '${API}',
    theme: 'auto',
    webhookUrl: ['https://hooks.slack.com/services/XXX/YYY/ZZZ'],
    debounceMs: 30000
  });
&lt;/script&gt;</code></pre>
          `;
        } catch (err) {
          out.innerHTML = '<p class="err">' + (err?.message || err) + '</p>';
        }
      });
    </script>
  </body>
</html>
